import axios from "axios";

//TODO
let cachedAccessTokens =
{
	'ext-api-calibration': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLWNhbGlicmF0aW9uIiwiaWF0IjoxNjgyODQ3NDg2LCJleHAiOjE2ODI5MzM4ODYsImF6cCI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5Iiwic2NvcGUiOiJhcGk6cmVhZCBhcGk6Y3JlYXRlIiwiZ3R5IjoiY2xpZW50LWNyZWRlbnRpYWxzIn0.HJGcg9JjoF4QdHNxHq4vDnfs7zbkuwkZNMc9ewshEI1TO4yvEw45PmOBifQKnBAvKNEgWbbR1xjj7AUjK7izDblOLhN4M5IN1itBX9G7z8gwThR5UlVjPn99Pl7rC9t73Sxqk54OuhV6wljc91RjmcJWkU56t0Ve9J6mHkHW7SuaeaXi6zY9yBIbYgxFnsqGnOyn1uOyKrwPz5udWYfoUwBS1s3dDuZFqdlAsxe7Q9_qP66xGPJ39dzcBfMmxN2NS1Th3QcBwROwF6H1fRVAbd45TBqLp2zp2iiIp61wzEdD54Otz3QSC3nCe-CFAeZL2c7kVSBEwQ2IqIY2iVLMSw',
	'ext-api-mood': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLW1vb2QiLCJpYXQiOjE2ODI4NDUxMzUsImV4cCI6MTY4MjkzMTUzNSwiYXpwIjoibjVvU3ZtazBneVNMU0pUbTBKYjBwSFFvMU5XanZvMTkiLCJzY29wZSI6ImFwaTpyZWFkIGFwaTpjcmVhdGUiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.c9pgdXSVr9cAKFNqUzO6TfbFGtIp5-W1RRND-ni4-_gaE2mYIZ1B9-uREPNeferNgWlbZKad6GKz36csok6eT-ePKmpLihQzD6s4ja2ajXdXmAEzJUjULFAGC6h14yY5PcREipiDIzLQPuBjglvJo2CGM5cjYlKZ-mX7MbqvJhRhdGe1BnJWksZAlZZCLLV8yKyyKmO_vb5oYce_tYe2pMKUcO7CNtPNsL4pGD4hTQwj3OWgbeafEu18OWZN0SCJkQXqLEUEqZ-c-mMzj5aFWYL6K5ZD3BIdbMxUYmCKGG5apteF-fsArD-vZb55Bj_FH1-j9Ox2fUepWW0ZGNdTGA',
	'ext-api-counter': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLWNvdW50ZXIiLCJpYXQiOjE2ODI2NTQyNDgsImV4cCI6MTY4Mjc0MDY0OCwiYXpwIjoibjVvU3ZtazBneVNMU0pUbTBKYjBwSFFvMU5XanZvMTkiLCJzY29wZSI6ImFwaTpyZWFkIGFwaTpjcmVhdGUiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.JRV6BRbmjTcrVNxvRR-y3KltKgwN7qzX6b3PkRdQ-sykK9AKbcHqiAdQN0eBukDm2GUbsag5kG2OSaAXvW_R2aK2O9sZVHbgiJujhPgNajg73jEhrRR7Axp5kCAb-YoEJcNp7dOd0iCeHTYIDzobOD5x93DqwZGpXW1qUKli9sMW9Tg-eg2qv-SNGPWf6QsNgTBFw10kpOG-xN1U2n_NDHiu42V1abS916sNwmUCAr7AJKMiPm34QMQD3NgHJVbNEMmMB310Zg-BaRMDs52sL0zi7enWgyttBHxsd4WXZOsLRJ0yJO8yywTdchjMlRIVehESHXO7yuN2HnD7T6l4Iw',
	'ext-api-notification': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLW5vdGlmaWNhdGlvbiIsImlhdCI6MTY4MjY1NDI0OCwiZXhwIjoxNjgyNzQwNjQ4LCJhenAiOiJuNW9Tdm1rMGd5U0xTSlRtMEpiMHBIUW8xTldqdm8xOSIsInNjb3BlIjoiYXBpOnJlYWQgYXBpOmNyZWF0ZSIsImd0eSI6ImNsaWVudC1jcmVkZW50aWFscyJ9.g-ZCggPDcEZ3ofr4-qNavaODQg_eDcVTuPucQHDXEsBXGWkyacM328Bt80sbifYJVd7qSllwrToi4HF2QzL4DW67_eC3DxN0xqBCEmNsmvqvDTorActvZIAE8EZQeCs5CIVuTq4c6gd-0heAFqyhsXjHSgbWnRaCz4LolxTWc_dDnDeMj07gArJrerU3GoWDnuogdba4uHeWbrnNjo6BpRmqzhB_x6oBDUPYuJk4i3tAZgwEjHzEQZmvjbYofbIRFSCiL_Xol9f5yToHjn5GBBu8vcZ-GVIKl3MvosnWzN9bmB0ubs-uYzPJ4KEK7kXYM2Gx2-pRm2P460aAKea4SQ',
	'ext-api-flow': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLWZsb3ciLCJpYXQiOjE2ODI4MzE4NzYsImV4cCI6MTY4MjkxODI3NiwiYXpwIjoibjVvU3ZtazBneVNMU0pUbTBKYjBwSFFvMU5XanZvMTkiLCJzY29wZSI6ImFwaTpyZWFkIGFwaTpjcmVhdGUiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.rK15FtKReY_tMglLtDUaE3IOIFLVwHWlUh6ktzHJgzEv0dKxdLp73vq3TAxyIF9qLFQZfrJjUkOd4cXe3igVF528dFHk8OcW2qDpHKod6l9HKGiRpVjbTZDBnypxtztq-D0H26dndqgvzftWs67vxm2C875wqIW4AQjQYXAka3Ypp90Zc6Ci2eJEebKvtO2gMDbGF3YI4kutwgjGtxN8nizwz7wfmCl_6Svwi4HEZW6tyYKCbdjzXya6W_yQI9lV3YdQXT2UFvFMPB3zmmaaOfTEaYN7K1Qa0gl_n1vf1eE5E2nGmnvsgCMv86sz_6dqRGtqOiN9GeyfUiUyGhXZbg',
	'ext-api-density': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLWRlbnNpdHkiLCJpYXQiOjE2ODI4NDUxNjAsImV4cCI6MTY4MjkzMTU2MCwiYXpwIjoibjVvU3ZtazBneVNMU0pUbTBKYjBwSFFvMU5XanZvMTkiLCJzY29wZSI6ImFwaTpyZWFkIGFwaTpjcmVhdGUiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.qEhRQgL-SFzfCXoimSS65upWr7qZPUqxHzIJOB-BdJ3gHf-PcWK2cKU6YkjgfCyAOwLufKlPZ9I9_0JYg42f0alqZsOJkdlerha6Xw6maKG8xdwFlVJlKwK4DMPFAnTiPOCnKHM2E4mNxp4q5Po_Ba-idUGTkw3e6dELA4PR7LgIB0nuzAlhvm90mHPMvJnk7LvUwHmTm9s_GZVmD0KjtwpDL0NBqJuQYSajLmfGZo47nX_OinRMdSLOB8Bb6eoF6m87YbbS-dZkPtmKGuqHSJal9_qVsnDzhC2AI4VJp3n6OB6LGYshYj9B4LRCxbeLjn4K9iaJCqomubiF7xfz0g',
}

const getAccessTokenFromTokenEndpoint = async (apiIdentifier) => {
	let options = {
		url: `https://${process.env.DCM_AUTH_DOMAIN}/oauth/token`,
		method: 'POST',
		headers: {'content-type': 'application/x-www-form-urlencoded'},
		data: {
			grant_type: 'client_credentials',
			client_id: process.env.DCM_AUTH_CLIENT_ID,
			client_secret: process.env.DCM_AUTH_CLIENT_SECRET,
			audience: apiIdentifier
		}
	};

	try {
		let res = await axios.request(options)
		return res.data
	} catch (err) {
		throw new Error(`Unable to get token for ${apiIdentifier}`)
	}
}

export const getAccessToken = async (apiIdentifier) => {
	let token = cachedAccessTokens[apiIdentifier]
	if (!token) {
		let res = await getAccessTokenFromTokenEndpoint(apiIdentifier)
		token = res['access_token']
		console.log(apiIdentifier, token)
		cachedAccessTokens[apiIdentifier] = token

		//remove the token from cache 60 seconds before expiry
		let expiry = res['expires_in'] - 60
		setTimeout(() => cachedAccessTokens[apiIdentifier] = undefined, expiry * 1000)

	}

	return token
}
