import axios from "axios";

//TODO
let cachedAccessTokens =
{
	'ext-api-calibration': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLWNhbGlicmF0aW9uIiwiaWF0IjoxNjgyNzQyOTIzLCJleHAiOjE2ODI4MjkzMjMsImF6cCI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5Iiwic2NvcGUiOiJhcGk6cmVhZCBhcGk6Y3JlYXRlIiwiZ3R5IjoiY2xpZW50LWNyZWRlbnRpYWxzIn0.RJy064fpY_44K9Y0URXs8s0q0dKQYyZNvhoFUWnFg3kkBsyLoCVxzH_sSrU3ZJeb6ugVc0z9F0fNhpIA55Z3DPO2HrTWXx4U0g1YeX4SvOWiogf_C3MAXOeIrbslvySCE0vMBbG0aGRjHTLqwgeSNr--3U4oaL0SxbT3leR4HkgIsaIGU73__ore8OsBWG4sM7CYjzGOFhLSA4JTu6GDb_FimY9lLbEJN0VMkcp4OTLGo4eT0DzQpzVU-4ICheWg6z98cCuAR6gHOIhh9oJToVySLOvgdTGGyS8b0vStSJqmYGiq7YqIbDVek2p_D6goV76disukD8r6fMUicxsfoQ',
	'ext-api-mood': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLW1vb2QiLCJpYXQiOjE2ODI3NTczMDcsImV4cCI6MTY4Mjg0MzcwNywiYXpwIjoibjVvU3ZtazBneVNMU0pUbTBKYjBwSFFvMU5XanZvMTkiLCJzY29wZSI6ImFwaTpyZWFkIGFwaTpjcmVhdGUiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.N1IervpEeyjlmFKgroKXk-gzGbrRp8oPINwEOlgJIpDCYUaq1e5pIGUg8xPUOA0t6vx-EdBYVnZme5EJMl9lQZcmV0DXAXex5-_mdDgQIHCruNXj2EvtWnEsp1bOfL7WbAsUgktHdABnW6aUt88cS35J9ena0t3f7MTydAzX_UCuaKu1tY6oY7XE1CbvkzMm1PnTzpzzYEsbL3WREPJyXt5ERbp82ATk0abl5DUQ_32IETufGlY3SY8Gzo8NdHDtH_l4Ge2UApR0G1n7CjlRpDnr48F8thK3rZjJid4gA0cmZO_y0eo6vNifcqOhZgYYi5TxZELiLYMauCYsuvYmbA',
	'ext-api-counter': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLWNvdW50ZXIiLCJpYXQiOjE2ODI2NTQyNDgsImV4cCI6MTY4Mjc0MDY0OCwiYXpwIjoibjVvU3ZtazBneVNMU0pUbTBKYjBwSFFvMU5XanZvMTkiLCJzY29wZSI6ImFwaTpyZWFkIGFwaTpjcmVhdGUiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.JRV6BRbmjTcrVNxvRR-y3KltKgwN7qzX6b3PkRdQ-sykK9AKbcHqiAdQN0eBukDm2GUbsag5kG2OSaAXvW_R2aK2O9sZVHbgiJujhPgNajg73jEhrRR7Axp5kCAb-YoEJcNp7dOd0iCeHTYIDzobOD5x93DqwZGpXW1qUKli9sMW9Tg-eg2qv-SNGPWf6QsNgTBFw10kpOG-xN1U2n_NDHiu42V1abS916sNwmUCAr7AJKMiPm34QMQD3NgHJVbNEMmMB310Zg-BaRMDs52sL0zi7enWgyttBHxsd4WXZOsLRJ0yJO8yywTdchjMlRIVehESHXO7yuN2HnD7T6l4Iw',
	'ext-api-notification': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLW5vdGlmaWNhdGlvbiIsImlhdCI6MTY4MjY1NDI0OCwiZXhwIjoxNjgyNzQwNjQ4LCJhenAiOiJuNW9Tdm1rMGd5U0xTSlRtMEpiMHBIUW8xTldqdm8xOSIsInNjb3BlIjoiYXBpOnJlYWQgYXBpOmNyZWF0ZSIsImd0eSI6ImNsaWVudC1jcmVkZW50aWFscyJ9.g-ZCggPDcEZ3ofr4-qNavaODQg_eDcVTuPucQHDXEsBXGWkyacM328Bt80sbifYJVd7qSllwrToi4HF2QzL4DW67_eC3DxN0xqBCEmNsmvqvDTorActvZIAE8EZQeCs5CIVuTq4c6gd-0heAFqyhsXjHSgbWnRaCz4LolxTWc_dDnDeMj07gArJrerU3GoWDnuogdba4uHeWbrnNjo6BpRmqzhB_x6oBDUPYuJk4i3tAZgwEjHzEQZmvjbYofbIRFSCiL_Xol9f5yToHjn5GBBu8vcZ-GVIKl3MvosnWzN9bmB0ubs-uYzPJ4KEK7kXYM2Gx2-pRm2P460aAKea4SQ',
	'ext-api-flow': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLWZsb3ciLCJpYXQiOjE2ODI4MzE4NzYsImV4cCI6MTY4MjkxODI3NiwiYXpwIjoibjVvU3ZtazBneVNMU0pUbTBKYjBwSFFvMU5XanZvMTkiLCJzY29wZSI6ImFwaTpyZWFkIGFwaTpjcmVhdGUiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.rK15FtKReY_tMglLtDUaE3IOIFLVwHWlUh6ktzHJgzEv0dKxdLp73vq3TAxyIF9qLFQZfrJjUkOd4cXe3igVF528dFHk8OcW2qDpHKod6l9HKGiRpVjbTZDBnypxtztq-D0H26dndqgvzftWs67vxm2C875wqIW4AQjQYXAka3Ypp90Zc6Ci2eJEebKvtO2gMDbGF3YI4kutwgjGtxN8nizwz7wfmCl_6Svwi4HEZW6tyYKCbdjzXya6W_yQI9lV3YdQXT2UFvFMPB3zmmaaOfTEaYN7K1Qa0gl_n1vf1eE5E2nGmnvsgCMv86sz_6dqRGtqOiN9GeyfUiUyGhXZbg',
	'ext-api-density': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im03cjM5Rjl1M0VIbkVQdmFBSGhOSCJ9.eyJodHRwczovL3Rlc3QuZGNtLmNyb3dkZWFnbGUuY29tLmF1L21ldGFkYXRhIjp7ImF1dGgwX2lkIjoiYXV0aDB8NjQ0OGI3Nzk4MTdhYmI0ZTYxNGVjMWU0In0sImlzcyI6Imh0dHBzOi8vZGNtLXRlc3QuZXUuYXV0aDAuY29tLyIsInN1YiI6Im41b1N2bWswZ3lTTFNKVG0wSmIwcEhRbzFOV2p2bzE5QGNsaWVudHMiLCJhdWQiOiJleHQtYXBpLWRlbnNpdHkiLCJpYXQiOjE2ODI3NTc5OTAsImV4cCI6MTY4Mjg0NDM5MCwiYXpwIjoibjVvU3ZtazBneVNMU0pUbTBKYjBwSFFvMU5XanZvMTkiLCJzY29wZSI6ImFwaTpyZWFkIGFwaTpjcmVhdGUiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.nD3GO13G7Wko1qOKbfI6BEh5swP4u274ghOHjp0yUX5dJH12LUIxmH6GbqpQA1gvsBcbZecniLG6bAigN0VkVUEJjMcRf3b_sqUNkuXpRU9hBSJ5ppjFntsPDUgtRNqynJ9WE903ZePBp0q2epytooXw0O2KeYZ13SvA8ui5xWeBjVF6tzkimHpc8tvCfE6sSTtfMIdRY8HEGlGNsYWtKY0UCTCYTzQPuoRPKsN5mu9_vv3pF3Y9rnrBwb0d3rWsn1N_zq98M0f3Rj-jFwwo6wvaSbugNVcUDOjSBitPCQhf8Sp4w3ey7uSGN13QlqTao3VBhwYohi_U0IlArQsFiA'
}

const getAccessTokenFromTokenEndpoint = async (apiIdentifier) => {
	let options = {
		url: `https://${process.env.DCM_AUTH_DOMAIN}/oauth/token`,
		method: 'POST',
		headers: {'content-type': 'application/x-www-form-urlencoded'},
		data: {
			grant_type: 'client_credentials',
			client_id: process.env.DCM_AUTH_CLIENT_ID,
			client_secret: process.env.DCM_AUTH_CLIENT_SECRET,
			audience: apiIdentifier
		}
	};

	try {
		let res = await axios.request(options)
		return res.data
	} catch (err) {
		throw new Error(`Unable to get token for ${apiIdentifier}`)
	}
}

export const getAccessToken = async (apiIdentifier) => {
	let token = cachedAccessTokens[apiIdentifier]
	if (!token) {
		let res = await getAccessTokenFromTokenEndpoint(apiIdentifier)
		token = res['access_token']
		console.log(apiIdentifier, token)
		cachedAccessTokens[apiIdentifier] = token

		//remove the token from cache 60 seconds before expiry
		let expiry = res['expires_in'] - 60
		setTimeout(() => cachedAccessTokens[apiIdentifier] = undefined, expiry * 1000)

	}

	return token
}
